# This is a complete solution for fixing your GitHub Actions tests

# 1. Create application-test.properties specifically for CI environment
# Place this file in src/test/resources/application-test.properties

spring.application.name=backend-test

# In-memory database for tests
spring.datasource.url=jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;MODE=MySQL
spring.datasource.username=sa
spring.datasource.password=
spring.datasource.driver-class-name=org.h2.Driver

# JPA Configuration
spring.jpa.hibernate.ddl-auto=create-drop
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.H2Dialect
spring.jpa.properties.hibernate.format_sql=true
spring.jpa.defer-datasource-initialization=true

# JWT Configuration
app.jwt-secret=testjwtsecretkeythatislongenoughfortestingtestjwtsecretkey
app.jwt-expiration-milliseconds=86400000

# Admin user password for tests
app.admin-user-password=admin123

# Server Configuration
server.port=0

# File Upload Configuration
spring.servlet.multipart.max-file-size=20MB
spring.servlet.multipart.max-request-size=20MB

# Important: Disable security for tests
spring.security.user.name=testuser
spring.security.user.password=testpass
spring.security.enabled=false

# 2. Add the H2 dependency to pom.xml
# Add this in your dependencies section:
# <dependency>
#    <groupId>com.h2database</groupId>
#    <artifactId>h2</artifactId>
#    <scope>test</scope>
# </dependency>

# 3. Update your GitHub Actions workflow file
# Create a .github/workflows/backend-ci.yml file like this:

name: Backend CI

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'backend/**'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: Build with Maven
      run: |
        cd backend
        ./mvnw clean package -DskipTests
    
    - name: Test with Maven
      run: |
        cd backend
        ./mvnw test -Dspring.profiles.active=test